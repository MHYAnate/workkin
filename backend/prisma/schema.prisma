// ===========================================
// WORKKIN - ENHANCED PRISMA SCHEMA
// Fully aligned with workflow document specifications
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

// ===========================================
// ENUMS - ENHANCED
// ===========================================

enum UserRole {
  USER
  PROVIDER
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BANNED
  PENDING_VERIFICATION
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum VerificationLevel {
  UNVERIFIED
  BASIC_VERIFIED        // Photo verification only
  DOCUMENT_VERIFIED     // Valid documents uploaded (as pictures)
  FULLY_VERIFIED        // Physical verification by Workkin partner
}

enum SubscriptionTier {
  FREE
  BASE
  MID
  TOP
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  PENDING
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentMethod {
  ZAINPAY
  PAYSTACK
  FLUTTERWAVE
  BANK_TRANSFER
  EXTERNAL           // For marketplace transactions outside Workkin
}

enum TransactionType {
  SUBSCRIPTION
  FEATURED_LISTING
  JOB_POSTING
  SERVICE_BOOKING
  PREMIUM_FEATURE
  STAFF_UPGRADE
  SQUAD_VERIFICATION
  WALLET_TOPUP
  WITHDRAWAL
  EXTERNAL_TRANSACTION  // For marketplace transactions
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DISPUTED
}

enum ListingStatus {
  DRAFT
  ACTIVE
  PAUSED
  SOLD
  RENTED
  LEASED
  EXPIRED
  DELETED
}

enum ListingType {
  FOR_SALE
  FOR_RENT
  FOR_LEASE
  FOR_SALE_AND_RENT
  FOR_SALE_AND_LEASE
}

enum VehicleCondition {
  NEW
  FOREIGN_USED
  LOCALLY_USED
  SALVAGE
}

enum VehicleType {
  CAR
  MOTORCYCLE
  TRUCK
  BUS
  VAN
  HEAVY_EQUIPMENT
}

enum VehicleSubtype {
  NEW_CARS
  USED_CARS
  CERTIFIED_PRE_OWNED
  LUXURY_EXOTIC_CARS
  NEW_MOTORCYCLES
  USED_MOTORCYCLES
  SPORTS_BIKES
  COMMERCIAL_MOTORCYCLES
  PICKUP_TRUCKS
  DELIVERY_TRUCKS
  BUSES_MINIBUSES
  TRAILERS
  COMMERCIAL_VANS
  CONSTRUCTION_EQUIPMENT
  AGRICULTURAL_EQUIPMENT
  INDUSTRIAL_MACHINERY
  FORKLIFTS_LOADERS
}

enum FuelType {
  PETROL
  DIESEL
  ELECTRIC
  HYBRID
  CNG
  LPG
}

enum TransmissionType {
  AUTOMATIC
  MANUAL
  CVT
  SEMI_AUTOMATIC
}

enum PropertyType {
  RESIDENTIAL
  COMMERCIAL
  LAND
  INDUSTRIAL
}

enum PropertySubtype {
  APARTMENT
  BUNGALOW
  DUPLEX
  TERRACE
  DETACHED_HOUSE
  SEMI_DETACHED
  STUDIO
  PENTHOUSE
  OFFICE_SPACE
  SHOP
  WAREHOUSE
  FACTORY
  LAND_PLOT
  FARM_LAND
}

enum FurnishingStatus {
  FURNISHED
  SEMI_FURNISHED
  UNFURNISHED
}

enum ProductCondition {
  NEW
  LIKE_NEW
  GOOD
  FAIR
  REFURBISHED
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  TEMPORARY
  INTERNSHIP
  FREELANCE
}

enum JobStatus {
  OPEN
  CLOSED
  PAUSED
  FILLED
  EXPIRED
}

enum ApplicationStatus {
  PENDING
  REVIEWED
  SHORTLISTED
  INTERVIEWED
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum RatingCategory {
  SERVICE
  VEHICLE
  PROPERTY
  PRODUCT
  JOB
  STAFF
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  AUDIO
  VIDEO
  SYSTEM
}

enum NotificationType {
  BOOKING
  MESSAGE
  RATING
  PAYMENT
  SUBSCRIPTION
  VERIFICATION
  JOB_APPLICATION
  SYSTEM
  PROMOTION
  AI_INSIGHT
  RATING_REMINDER
}

enum ReportReason {
  SPAM
  INAPPROPRIATE
  FRAUD
  HARASSMENT
  FAKE_LISTING
  OTHER
}

enum ReportStatus {
  PENDING
  UNDER_REVIEW
  RESOLVED
  DISMISSED
}

enum ContactPreference {
  CALL
  WHATSAPP
  PLATFORM_MESSAGE
  ALL
}

enum StaffRole {
  MANAGER
  SUPERVISOR
  EMPLOYEE
  TRAINEE
}

enum StaffStatus {
  ACTIVE
  INACTIVE
  PENDING
  TERMINATED
}

enum SquadStatus {
  ACTIVE
  INACTIVE
  PENDING_VERIFICATION
  VERIFIED
}

enum DocumentType {
  ID_CARD
  BUSINESS_REGISTRATION
  CAC
  DRIVERS_LICENSE
  VEHICLE_REGISTRATION
  PROPERTY_DEED
  VIN_PHOTO
  REGISTRATION_DOC
  INSURANCE_DOC
  INSPECTION_CERTIFICATE
  OWNERSHIP_DOC
  MILEAGE_VERIFICATION
  SURVEY_PLAN
  BUILDING_APPROVAL
  OWNER_AUTHORIZATION
}

enum DocumentRequirement {
  PHOTO_OF_ORIGINAL    // Must be photo of physical document
  SCAN                 // Scanned copy accepted
  PDF                  // PDF document accepted
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum ServicePermission {
  VEHICLE_MARKET_ACCESS     // IDs: 133, 134
  REAL_ESTATE_MARKET_ACCESS // IDs: 82, 131, 132
  FINANCIAL_SERVICES        // IDs: 135-140
  GENERAL_MARKET_ACCESS     // All users can access
  SERVICE_PROVIDER          // Standard service provider
}

enum TransactionVisibility {
  HIDDEN           // Visible to no one
  SUBSCRIBED_ONLY  // Visible to subscribed users only
  ALL_USERS        // Visible to all registered users
  PUBLIC           // Visible to everyone (including unregistered)
}

enum AIInsightType {
  MARKET_INSIGHT
  PRICING_RECOMMENDATION
  DEMAND_FORECAST
  COMPETITOR_ANALYSIS
  SERVICE_RECOMMENDATION
  TRANSACTION_RISK
  BUSINESS_INTELLIGENCE
}

enum ZainpayEventType {
  DEPOSIT_SUCCESS
  DEPOSIT_FAILED
  TRANSFER_SUCCESS
  TRANSFER_FAILED
  CARD_PAYMENT_SUCCESS
  CARD_PAYMENT_FAILED
  VIRTUAL_ACCOUNT_CREATED
  SETTLEMENT_PROCESSED
}

// ===========================================
// USER MODELS - ENHANCED
// ===========================================

model User {
  id                    String              @id @default(cuid())
  email                 String?             @unique
  phone                 String              @unique
  password              String
  firstName             String
  lastName              String
  displayName           String?
  avatar                String?
  coverImage            String?
  bio                   String?             @db.Text
  gender                Gender?
  dateOfBirth           DateTime?
  
  // Roles and Status
  role                  UserRole            @default(USER)
  status                UserStatus          @default(PENDING_VERIFICATION)
  isProvider            Boolean             @default(false)
  isClient              Boolean             @default(true)
  
  // Work Status (for Talent Pool)
  isOpenToWork          Boolean             @default(false)
  isCurrentlyHiring     Boolean             @default(false)
  workStatusUpdatedAt   DateTime?
  
  // Profile Sharing
  profileSharingEnabled Boolean             @default(true)
  profileShareToken     String?             @unique
  profileShareExpiresAt DateTime?
  lastProfileShareAt    DateTime?
  profileViewCount      Int                 @default(0)
  
  // Verification
  emailVerified         Boolean             @default(false)
  emailVerifiedAt       DateTime?
  phoneVerified         Boolean             @default(false)
  phoneVerifiedAt       DateTime?
  verificationLevel     VerificationLevel   @default(UNVERIFIED)
  verificationRequested Boolean             @default(false)
  verificationRequestedAt DateTime?
  
  // Location
  country               String              @default("Nigeria")
  countryCode           String              @default("NG")
  state                 String?
  city                  String?
  area                  String?
  address               String?
  latitude              Float?
  longitude             Float?
  
  // Contact Preferences
  contactPreference     ContactPreference   @default(ALL)
  showFullAddress       Boolean             @default(false)
  
  // External Payment Info (visibility controlled by subscription)
  bankName              String?
  bankAccountNumber     String?
  bankAccountName       String?
  bankCode              String?
  externalPaymentLink   String?
  preferredPaymentMethods String[]
  
  // Timestamps
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  lastLoginAt           DateTime?
  lastActiveAt          DateTime?
  deletedAt             DateTime?
  
  // Service Type Assignment (Critical for marketplace permissions)
  serviceTypeId         String?             // Links to specific service ID (1-140)
  
  // Relations
  serviceType           ServiceType?        @relation(fields: [serviceTypeId], references: [id])
  profile               Profile?
  subscription          Subscription?
  wallet                Wallet?
  
  // Services
  services              Service[]
  serviceBookingsAsClient   Booking[]       @relation("ClientBookings")
  serviceBookingsAsProvider Booking[]       @relation("ProviderBookings")
  
  // Market Listings (access controlled by serviceType permissions)
  vehicleListings       VehicleListing[]
  propertyListings      PropertyListing[]
  productListings       ProductListing[]
  
  // Jobs
  jobPostings           Job[]               @relation("JobPoster")
  jobApplications       JobApplication[]
  
  // Staff & Squads
  staffAsEmployer       Staff[]             @relation("Employer")
  staffAsEmployee       Staff[]             @relation("Employee")
  squadMemberships      SquadMember[]
  ownedSquads           Squad[]             @relation("SquadOwner")
  
  // Messaging
  sentMessages          Message[]           @relation("MessageSender")
  chatRoomMemberships   ChatRoomMember[]
  
  // Ratings & Reviews
  ratingsGiven          Rating[]            @relation("RatingGiver")
  ratingsReceived       Rating[]            @relation("RatingReceiver")
  reviewResponses       ReviewResponse[]
  
  // Favorites
  favorites             Favorite[]
  
  // Notifications
  notifications         Notification[]
  
  // Reports
  reportsMade           Report[]            @relation("Reporter")
  reportsReceived       Report[]            @relation("Reported")
  
  // Transactions
  transactions          Transaction[]
  
  // Verification Documents
  verificationDocuments VerificationDocument[]
  
  // Document Verifications
  vehicleDocuments      VehicleDocument[]
  propertyDocuments     PropertyDocument[]
  documentVerifications DocumentVerification[]
  
  // Sessions & Tokens
  sessions              Session[]
  refreshTokens         RefreshToken[]
  otps                  OTP[]
  
  // AI Insights
  aiInsights            AIInsight[]
  aiQueries             AIQuery[]
  
  // Talent Pool
  talentPoolEntry       TalentPoolEntry?
  
  // Rating Invitations
  ratingInvitations     RatingInvitation[]
  
  // Zainpay Integration
  zainpayWebhooks       ZainpayWebhook[]
  virtualAccount        VirtualAccount?
  
  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([isProvider])
  @@index([isOpenToWork])
  @@index([isCurrentlyHiring])
  @@index([state, city])
  @@index([serviceTypeId])
  @@index([profileShareToken])
  @@map("users")
}

model Profile {
  id                    String              @id @default(cuid())
  userId                String              @unique
  
  // Professional Info
  businessName          String?
  businessDescription   String?             @db.Text
  businessLogo          String?
  businessCoverImage    String?
  yearsOfExperience     Int?
  qualifications        String[]
  certifications        String[]
  
  // Social Links
  website               String?
  facebook              String?
  twitter               String?
  instagram             String?
  linkedin              String?
  youtube               String?
  tiktok                String?
  
  // Ratings Summary
  averageRating         Float               @default(0)
  totalRatings          Int                 @default(0)
  providerRating        Float               @default(0)
  clientRating          Float               @default(0)
  
  // Stats
  totalServicesCompleted Int                @default(0)
  totalVehiclesSold     Int                 @default(0)
  totalPropertiesSold   Int                 @default(0)
  totalProductsSold     Int                 @default(0)
  responseRate          Float               @default(0)
  responseTime          Int?                // in minutes
  
  // Service Areas
  serviceAreas          String[]
  serviceRadius         Int?                // in km
  
  // Market-specific Stats
  vehicleDealership     Boolean             @default(false)
  realEstateAgency      Boolean             @default(false)
  propertyManagement    Boolean             @default(false)
  
  // Timestamps
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  // Relations
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("profiles")
}

model Session {
  id            String    @id @default(cuid())
  userId        String
  token         String    @unique
  userAgent     String?
  ipAddress     String?
  expiresAt     DateTime
  createdAt     DateTime  @default(now())
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@map("sessions")
}

model RefreshToken {
  id            String    @id @default(cuid())
  userId        String
  token         String    @unique
  expiresAt     DateTime
  createdAt     DateTime  @default(now())
  revokedAt     DateTime?
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model OTP {
  id            String    @id @default(cuid())
  userId        String
  code          String
  type          String    // email_verification, phone_verification, password_reset
  expiresAt     DateTime
  usedAt        DateTime?
  createdAt     DateTime  @default(now())
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([code])
  @@map("otps")
}

// ===========================================
// VERIFICATION MODELS - ENHANCED
// ===========================================

model VerificationDocument {
  id                    String              @id @default(cuid())
  userId                String
  
  // Document Details
  type                  DocumentType
  requirement           DocumentRequirement @default(PHOTO_OF_ORIGINAL)  // Must be picture of original
  documentUrl           String
  thumbnailUrl          String?
  
  // Document Metadata (for pictures)
  fileType              String              // image/jpeg, image/png, application/pdf
  fileSize              Int?                // in bytes
  dimensions            Json?               // { width: number, height: number }
  captureTimestamp      DateTime?           // When photo was taken
  geolocation           Json?               // { lat: number, lng: number }
  
  // Processing
  status                DocumentStatus      @default(PENDING)
  rejectionReason       String?
  verifiedBy            String?
  verifiedAt            DateTime?
  
  // Quality Checks
  isLegible             Boolean?            @default(true)
  ocrText               String?             @db.Text
  validationScore       Float?              // 0-1 confidence score
  
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  verifications         DocumentVerification[]
  
  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([requirement])
  @@map("verification_documents")
}

model DocumentVerification {
  id                    String              @id @default(cuid())
  documentId            String
  userId                String
  
  verificationMethod    String              // manual, automated, third_party, partner
  qualityScore          Float?              // 0-1
  isLegible             Boolean?
  ocrConfidence         Float?
  validationErrors      String[]
  notes                 String?
  
  verifiedAt            DateTime?
  createdAt             DateTime            @default(now())
  
  document              VerificationDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([documentId])
  @@index([userId])
  @@map("document_verifications")
}

// ===========================================
// SUBSCRIPTION & PAYMENT MODELS - ENHANCED
// ===========================================

model Subscription {
  id                String              @id @default(cuid())
  userId            String              @unique
  
  tier              SubscriptionTier    @default(FREE)
  status            SubscriptionStatus  @default(ACTIVE)
  
  // Limits based on tier (from workflow document)
  freeServiceListings   Int             @default(1)
  freeVehicleSlots      Int             @default(1)
  freePropertySlots     Int             @default(1)
  freeProductSlots      Int             @default(1)
  freeFeaturedPerMonth  Int             @default(0)
  
  // Current usage
  usedServiceListings   Int             @default(0)
  usedVehicleSlots      Int             @default(0)
  usedPropertySlots     Int             @default(0)
  usedProductSlots      Int             @default(0)
  usedFeaturedThisMonth Int             @default(0)
  
  // Visibility Permissions (Critical for external payments)
  isContactInfoVisible  Boolean         @default(false)  // FREE: false, SUBSCRIBED: true
  isPaymentInfoVisible  Boolean         @default(false)  // FREE: false, SUBSCRIBED: true
  canViewExternalLinks  Boolean         @default(false)  // FREE: false, SUBSCRIBED: true
  
  // Billing
  price             Float               @default(0)
  currency          String              @default("NGN")
  billingCycle      String?             // monthly, yearly, lifetime
  
  startDate         DateTime            @default(now())
  endDate           DateTime?
  cancelledAt       DateTime?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions      Transaction[]
  usageHistory      SubscriptionUsage[]
  
  @@map("subscriptions")
}

model Wallet {
  id                String              @id @default(cuid())
  userId            String              @unique
  
  balance           Float               @default(0)
  currency          String              @default("NGN")
  
  // Zainpay Integration
  zainboxCode       String?
  virtualAccountNumber String?
  virtualAccountBank   String?
  virtualAccountName   String?
  virtualAccountStatus String           @default("active") // active, inactive
  
  // Auto Settlement
  autoSettlementEnabled Boolean         @default(false)
  settlementAccountNumber String?
  settlementBankCode   String?
  settlementPercentage Float?           // Percentage to settle
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions      Transaction[]
  virtualAccount    VirtualAccount?
  
  @@map("wallets")
}

model VirtualAccount {
  id                String              @id @default(cuid())
  userId            String              @unique
  walletId          String?             @unique  // FIXED: Added @unique for one-to-one relation
  
  // Account Details
  accountNumber     String              @unique
  accountName       String
  bankCode          String
  bankName          String
  bankType          String              // gtBank, fidelity, fcmb
  
  // Zainpay Metadata
  zainboxCode       String?
  virtualAccountId  String?             // Zainpay internal ID
  status            String              @default("active")
  
  // Dynamic Account (for one-time payments)
  isDynamic         Boolean             @default(false)
  dynamicAmount     Float?
  dynamicExpiresAt  DateTime?
  dynamicTxnRef     String?
  dynamicCallbackUrl String?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  wallet            Wallet?             @relation(fields: [walletId], references: [id])
  
  @@index([userId])
  @@index([accountNumber])
  @@index([zainboxCode])
  @@map("virtual_accounts")
}

model Transaction {
  id                String              @id @default(cuid())
  userId            String
  walletId          String?
  subscriptionId    String?
  
  type              TransactionType
  amount            Float
  currency          String              @default("NGN")
  fee               Float               @default(0)
  
  status            PaymentStatus       @default(PENDING)
  paymentMethod     PaymentMethod?
  
  // Payment Gateway References
  txnRef            String              @unique
  paymentRef        String?
  gatewayResponse   Json?
  
  // External Payment Tracking (for marketplace transactions)
  isExternal        Boolean             @default(false)
  externalReference String?             // External system reference
  externalPlatform  String?             // Platform where payment occurred
  externalPaymentMethod String?         // Method used externally
  
  description       String?
  metadata          Json?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  completedAt       DateTime?
  
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  wallet            Wallet?             @relation(fields: [walletId], references: [id])
  subscription      Subscription?       @relation(fields: [subscriptionId], references: [id])
  
  @@index([userId])
  @@index([txnRef])
  @@index([status])
  @@index([type])
  @@index([isExternal])
  @@map("transactions")
}

model ZainpayWebhook {
  id                String              @id @default(cuid())
  userId            String
  zainboxCode       String?
  
  eventType         ZainpayEventType
  payload           Json
  signature         String
  isVerified        Boolean             @default(false)
  verificationError String?
  
  processedAt       DateTime?
  processingError   String?
  
  createdAt         DateTime            @default(now())
  
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([zainboxCode])
  @@index([eventType])
  @@index([createdAt])
  @@map("zainpay_webhooks")
}

// ===========================================
// SERVICE MODELS - ENHANCED WITH PERMISSIONS
// ===========================================

model ServiceCategory {
  id                String              @id @default(cuid())
  name              String
  slug              String              @unique
  description       String?             @db.Text
  icon              String?
  image             String?
  
  parentId          String?
  order             Int                 @default(0)
  isActive          Boolean             @default(true)
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  parent            ServiceCategory?    @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children          ServiceCategory[]   @relation("CategoryHierarchy")
  serviceTypes      ServiceType[]
  
  @@map("service_categories")
}

model ServiceType {
  id                String              @id @default(cuid())
  categoryId        String
  
  // Critical: The service ID from workflow (1-140)
  serviceId         Int                 @unique
  name              String
  slug              String              @unique
  description       String?             @db.Text
  icon              String?
  
  // Service Category Mapping
  workflowCategory  String              // Auto & Transport, Home & Property, Lifestyle & Professional
  
  // Permission System (Critical for marketplace access)
  permissions       ServicePermission[]
  allowedMarketModules String[]         // ["vehicle", "property", "general", "financial"]
  
  // Special Permissions based on service ID
  hasVehicleMarketAccess   Boolean      @default(false)
  hasPropertyMarketAccess  Boolean      @default(false)
  isFinancialService       Boolean      @default(false)
  
  isActive          Boolean             @default(true)
  order             Int                 @default(0)
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  category          ServiceCategory     @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  services          Service[]
  users             User[]
  squads            Squad[]             // FIXED: Added opposite relation field
  
  @@index([categoryId])
  @@index([serviceId])
  @@index([workflowCategory])
  @@index([hasVehicleMarketAccess])
  @@index([hasPropertyMarketAccess])
  @@map("service_types")
}

model Service {
  id                String              @id @default(cuid())
  userId            String
  serviceTypeId     String
  
  title             String
  slug              String
  description       String              @db.Text
  
  // Pricing
  price             Float?
  priceType         String?             // fixed, hourly, daily, negotiable, starting_from
  currency          String              @default("NGN")
  
  // Location
  country           String              @default("Nigeria")
  state             String?
  city              String?
  address           String?
  latitude          Float?
  longitude         Float?
  serviceRadius     Int?                // in km
  
  // Media
  images            String[]
  videos            String[]
  
  // Availability
  isAvailable       Boolean             @default(true)
  availabilitySchedule Json?
  
  // Status
  status            ListingStatus       @default(ACTIVE)
  isFeatured        Boolean             @default(false)
  featuredUntil     DateTime?
  
  // Subscription Enforcement
  isUsingFreeSlot   Boolean             @default(true)
  subscriptionTierUsed SubscriptionTier?
  
  // Stats
  viewCount         Int                 @default(0)
  inquiryCount      Int                 @default(0)
  bookingCount      Int                 @default(0)
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  publishedAt       DateTime?
  
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  serviceType       ServiceType         @relation(fields: [serviceTypeId], references: [id])
  bookings          Booking[]
  ratings           Rating[]
  favorites         Favorite[]
  
  @@index([userId])
  @@index([serviceTypeId])
  @@index([status])
  @@index([isFeatured])
  @@index([state, city])
  @@index([isUsingFreeSlot])
  @@map("services")
}

model Booking {
  id                String              @id @default(cuid())
  serviceId         String
  clientId          String
  providerId        String
  
  // Booking Details
  scheduledDate     DateTime
  scheduledTime     String?
  duration          Int?                // in minutes
  
  // Location
  address           String?
  latitude          Float?
  longitude         Float?
  
  // Pricing (In-app payment via Zainpay)
  agreedPrice       Float?
  currency          String              @default("NGN")
  depositAmount     Float?
  depositPaid       Boolean             @default(false)
  depositTxnRef     String?             // Zainpay transaction reference
  
  // Status
  status            BookingStatus       @default(PENDING)
  
  // Notes
  clientNotes       String?             @db.Text
  providerNotes     String?             @db.Text
  
  // Completion
  completedAt       DateTime?
  cancelledAt       DateTime?
  cancellationReason String?
  
  // Rating Tracking
  ratingInvitationSent Boolean          @default(false)
  ratingDeadline      DateTime?         // 48 hours after completion
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  service           Service             @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  client            User                @relation("ClientBookings", fields: [clientId], references: [id])
  provider          User                @relation("ProviderBookings", fields: [providerId], references: [id])
  ratings           Rating[]
  ratingInvitation  RatingInvitation?
  
  @@index([serviceId])
  @@index([clientId])
  @@index([providerId])
  @@index([status])
  @@index([scheduledDate])
  @@index([ratingDeadline])
  @@map("bookings")
}

// ===========================================
// VEHICLE MARKET MODELS - ENHANCED
// ===========================================

model VehicleListing {
  id                String              @id @default(cuid())
  userId            String
  
  // Basic Info
  title             String
  slug              String
  description       String              @db.Text
  
  // Listing Type
  listingType       ListingType
  
  // Vehicle Details
  vehicleType       VehicleType
  vehicleSubtype    VehicleSubtype?
  make              String
  model             String
  year              Int
  trim              String?
  vin               String?
  vinVerified       Boolean             @default(false)
  
  // Specifications
  mileage           Int?
  fuelType          FuelType?
  transmission      TransmissionType?
  engineSize        String?
  color             String?
  interiorColor     String?
  seatingCapacity   Int?
  numberOfDoors     Int?
  
  // Condition
  condition         VehicleCondition
  accidentHistory   String?             @db.Text
  previousOwners    Int?
  
  // Features (JSON arrays for flexibility)
  safetyFeatures    String[]
  comfortFeatures   String[]
  entertainmentFeatures String[]
  performanceFeatures   String[]
  
  // Pricing
  salePrice         Float?
  leasePrice        Float?
  rentPrice         Float?
  currency          String              @default("NGN")
  isNegotiable      Boolean             @default(true)
  
  // Location
  country           String              @default("Nigeria")
  state             String
  city              String
  address           String?
  latitude          Float?
  longitude         Float?
  
  // Media
  images            String[]
  videos            String[]
  tourUrl           String?
  
  // Verification
  verificationLevel VerificationLevel   @default(UNVERIFIED)
  documentsVerified Boolean             @default(false)
  
  // External Payment Info (visibility controlled by subscription)
  preferredPaymentMethods String[]
  bankName          String?
  bankAccountNumber String?
  bankAccountName   String?
  bankCode          String?
  externalPaymentLink String?
  financingAvailable Boolean            @default(false)
  
  // Visibility Controls
  contactInfoVisibility TransactionVisibility @default(SUBSCRIBED_ONLY)
  paymentInfoVisibility TransactionVisibility @default(SUBSCRIBED_ONLY)
  
  // Publication Settings
  status            ListingStatus       @default(DRAFT)
  contactPreference ContactPreference   @default(ALL)
  showFullAddress   Boolean             @default(false)
  allowTestDrive    Boolean             @default(true)
  
  // Featured Listing (paid in-app via Zainpay)
  isFeatured        Boolean             @default(false)
  featuredUntil     DateTime?
  featuredTxnRef    String?             // Zainpay transaction reference
  
  // Stats
  viewCount         Int                 @default(0)
  inquiryCount      Int                 @default(0)
  saveCount         Int                 @default(0)
  testDriveCount    Int                 @default(0)
  
  // Subscription Enforcement
  isUsingFreeSlot   Boolean             @default(true)
  subscriptionTierUsed SubscriptionTier?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  publishedAt       DateTime?
  soldAt            DateTime?
  
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents         VehicleDocument[]
  testDriveSchedules TestDriveSchedule[]
  transactions      VehicleTransaction[]
  ratings           Rating[]
  favorites         Favorite[]
  
  @@index([userId])
  @@index([vehicleType])
  @@index([make, model])
  @@index([status])
  @@index([isFeatured])
  @@index([state, city])
  @@index([listingType])
  @@index([verificationLevel])
  @@map("vehicle_listings")
}

model VehicleDocument {
  id                String              @id @default(cuid())
  vehicleListingId  String
  userId            String
  
  type              DocumentType        // vin_photo, registration, insurance, etc.
  requirement       DocumentRequirement @default(PHOTO_OF_ORIGINAL)
  documentUrl       String
  thumbnailUrl      String?
  
  // Document Metadata
  fileType          String              // image/jpeg, image/png
  fileSize          Int?
  captureTimestamp  DateTime?
  
  status            DocumentStatus      @default(PENDING)
  verifiedAt        DateTime?
  verificationNotes String?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  vehicleListing    VehicleListing      @relation(fields: [vehicleListingId], references: [id], onDelete: Cascade)
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([vehicleListingId])
  @@index([type])
  @@index([status])
  @@map("vehicle_documents")
}

model TestDriveSchedule {
  id                String              @id @default(cuid())
  vehicleListingId  String
  buyerId           String
  sellerId          String
  
  scheduledDate     DateTime
  scheduledTime     String
  status            String              @default("pending") // pending, confirmed, completed, cancelled
  notes             String?
  
  // Contact Info (only visible to subscribed users)
  buyerContactVisible Boolean           @default(false)
  sellerContactVisible Boolean          @default(false)
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  vehicleListing    VehicleListing      @relation(fields: [vehicleListingId], references: [id], onDelete: Cascade)
  
  @@index([vehicleListingId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([scheduledDate])
  @@map("test_drive_schedules")
}

model VehicleTransaction {
  id                String              @id @default(cuid())
  vehicleListingId  String
  buyerId           String
  sellerId          String
  
  transactionType   String              // sale, lease, rent
  agreedPrice       Float
  currency          String              @default("NGN")
  
  // External Payment Tracking
  isExternal        Boolean             @default(true)  // All vehicle payments are external
  externalReference String?             // External payment reference
  externalPlatform  String?             // Where payment occurred
  externalPaymentMethod String?         // Method used
  
  status            String              @default("pending") // pending, completed, cancelled
  completedAt       DateTime?
  
  // Communication
  buyerNotes        String?
  sellerNotes       String?
  
  // Rating tracking (48-hour window)
  buyerRated        Boolean             @default(false)
  sellerRated       Boolean             @default(false)
  ratingDeadline    DateTime?           // 48 hours from completion
  ratingReminderSent Boolean            @default(false)
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  vehicleListing    VehicleListing      @relation(fields: [vehicleListingId], references: [id], onDelete: Cascade)
  ratingInvitations RatingInvitation[]
  
  @@index([vehicleListingId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([ratingDeadline])
  @@map("vehicle_transactions")
}

// ===========================================
// REAL ESTATE MARKET MODELS - ENHANCED
// ===========================================

model PropertyListing {
  id                String              @id @default(cuid())
  userId            String
  
  // Basic Info
  title             String
  slug              String
  description       String              @db.Text
  
  // Listing Type
  listingType       ListingType
  
  // Property Details
  propertyType      PropertyType
  propertySubtype   PropertySubtype?
  
  // Specifications
  bedrooms          Int?
  bathrooms         Int?
  toilets           Int?
  size              Float?              // in sqm
  landSize          Float?              // for land plots
  yearBuilt         Int?
  floors            Int?
  
  furnishing        FurnishingStatus?
  
  // Features (JSON arrays)
  interiorFeatures  String[]
  exteriorFeatures  String[]
  utilities         String[]
  securityFeatures  String[]
  communityFeatures String[]
  
  // Pricing
  salePrice         Float?
  rentPrice         Float?
  leasePrice        Float?
  serviceCharge     Float?
  currency          String              @default("NGN")
  isNegotiable      Boolean             @default(true)
  
  // Location
  country           String              @default("Nigeria")
  state             String
  city              String
  area              String?
  address           String?
  latitude          Float?
  longitude         Float?
  
  // Media
  images            String[]
  videos            String[]
  virtualTourUrl    String?
  floorPlanUrl      String?
  surveyPlanUrl     String?
  
  // Verification & Documentation
  verificationLevel VerificationLevel   @default(UNVERIFIED)
  ownershipType     String?             // owner, agent, manager
  ownerAuthorization Boolean            @default(false)
  
  // External Payment Info (visibility controlled by subscription)
  preferredPaymentMethods String[]
  bankName          String?
  bankAccountNumber String?
  bankAccountName   String?
  bankCode          String?
  externalPaymentLink String?
  mortgageAvailable Boolean             @default(false)
  
  // Visibility Controls
  contactInfoVisibility TransactionVisibility @default(SUBSCRIBED_ONLY)
  paymentInfoVisibility TransactionVisibility @default(SUBSCRIBED_ONLY)
  
  // Publication Settings
  status            ListingStatus       @default(DRAFT)
  availabilityDate  DateTime?
  contactPreference ContactPreference   @default(ALL)
  showFullAddress   Boolean             @default(false)
  allowViewingSchedule Boolean          @default(true)
  
  // Featured Listing (paid in-app via Zainpay)
  isFeatured        Boolean             @default(false)
  featuredUntil     DateTime?
  featuredTxnRef    String?             // Zainpay transaction reference
  
  // Stats
  viewCount         Int                 @default(0)
  inquiryCount      Int                 @default(0)
  saveCount         Int                 @default(0)
  viewingCount      Int                 @default(0)
  
  // Subscription Enforcement
  isUsingFreeSlot   Boolean             @default(true)
  subscriptionTierUsed SubscriptionTier?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  publishedAt       DateTime?
  soldAt            DateTime?
  rentedAt          DateTime?
  
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents         PropertyDocument[]
  viewingSchedules  ViewingSchedule[]
  transactions      PropertyTransaction[]
  ratings           Rating[]
  favorites         Favorite[]
  
  @@index([userId])
  @@index([propertyType])
  @@index([status])
  @@index([isFeatured])
  @@index([state, city])
  @@index([listingType])
  @@index([verificationLevel])
  @@map("property_listings")
}

model PropertyDocument {
  id                String              @id @default(cuid())
  propertyListingId String
  userId            String
  
  type              DocumentType        // deed, c_of_o, survey_plan, etc.
  requirement       DocumentRequirement @default(PHOTO_OF_ORIGINAL)
  documentUrl       String
  thumbnailUrl      String?
  
  // Document Metadata
  fileType          String              // image/jpeg, image/png
  fileSize          Int?
  captureTimestamp  DateTime?
  
  status            DocumentStatus      @default(PENDING)
  verifiedAt        DateTime?
  verificationNotes String?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  propertyListing   PropertyListing     @relation(fields: [propertyListingId], references: [id], onDelete: Cascade)
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([propertyListingId])
  @@index([type])
  @@index([status])
  @@map("property_documents")
}

model ViewingSchedule {
  id                String              @id @default(cuid())
  propertyListingId String
  viewerId          String
  agentOwnerId      String
  
  scheduledDate     DateTime
  scheduledTime     String
  status            String              @default("pending") // pending, confirmed, completed, cancelled
  notes             String?
  
  // Contact Info (only visible to subscribed users)
  viewerContactVisible Boolean          @default(false)
  agentContactVisible  Boolean          @default(false)
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  propertyListing   PropertyListing     @relation(fields: [propertyListingId], references: [id], onDelete: Cascade)
  
  @@index([propertyListingId])
  @@index([viewerId])
  @@index([agentOwnerId])
  @@index([scheduledDate])
  @@map("viewing_schedules")
}

model PropertyTransaction {
  id                String              @id @default(cuid())
  propertyListingId String
  buyerRenterId     String
  sellerLandlordId  String
  
  transactionType   String              // sale, rent, lease
  agreedPrice       Float
  currency          String              @default("NGN")
  
  // External Payment Tracking
  isExternal        Boolean             @default(true)  // All property payments are external
  externalReference String?             // External payment reference
  externalPlatform  String?             // Where payment occurred
  externalPaymentMethod String?         // Method used
  
  status            String              @default("pending") // pending, completed, cancelled
  completedAt       DateTime?
  
  // Rating tracking (48-hour window)
  buyerRenterRated  Boolean             @default(false)
  sellerLandlordRated Boolean           @default(false)
  ratingDeadline    DateTime?           // 48 hours from completion
  ratingReminderSent Boolean            @default(false)
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  propertyListing   PropertyListing     @relation(fields: [propertyListingId], references: [id], onDelete: Cascade)
  ratingInvitations RatingInvitation[]
  
  @@index([propertyListingId])
  @@index([buyerRenterId])
  @@index([sellerLandlordId])
  @@index([status])
  @@index([ratingDeadline])
  @@map("property_transactions")
}

// ===========================================
// GENERAL MARKET MODELS - ENHANCED
// ===========================================

model ProductListing {
  id                String              @id @default(cuid())
  userId            String
  
  // Basic Info
  title             String
  slug              String
  description       String              @db.Text
  
  // Listing Type
  listingType       ListingType
  
  // Product Details
  category          String
  subcategory       String?
  brand             String?
  condition         ProductCondition
  
  // Specifications
  specifications    Json?
  features          String[]
  
  // Pricing
  salePrice         Float?
  leasePrice        Float?
  rentPrice         Float?
  currency          String              @default("NGN")
  isNegotiable      Boolean             @default(true)
  
  // Location
  country           String              @default("Nigeria")
  state             String
  city              String
  address           String?
  latitude          Float?
  longitude         Float?
  
  // Delivery
  deliveryAvailable Boolean             @default(false)
  deliveryFee       Float?
  pickupOnly        Boolean             @default(false)
  
  // Media
  images            String[]
  videos            String[]
  
  // External Payment Info (visibility controlled by subscription)
  preferredPaymentMethods String[]
  bankName          String?
  bankAccountNumber String?
  bankAccountName   String?
  bankCode          String?
  externalPaymentLink String?
  
  // Visibility Controls
  contactInfoVisibility TransactionVisibility @default(SUBSCRIBED_ONLY)
  paymentInfoVisibility TransactionVisibility @default(SUBSCRIBED_ONLY)
  
  // Publication Settings
  status            ListingStatus       @default(DRAFT)
  contactPreference ContactPreference   @default(ALL)
  
  // Featured Listing (paid in-app via Zainpay)
  isFeatured        Boolean             @default(false)
  featuredUntil     DateTime?
  featuredTxnRef    String?             // Zainpay transaction reference
  
  // Stats
  viewCount         Int                 @default(0)
  inquiryCount      Int                 @default(0)
  saveCount         Int                 @default(0)
  
  // Subscription Enforcement
  isUsingFreeSlot   Boolean             @default(true)
  subscriptionTierUsed SubscriptionTier?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  publishedAt       DateTime?
  soldAt            DateTime?
  
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions      ProductTransaction[]
  ratings           Rating[]
  favorites         Favorite[]
  
  @@index([userId])
  @@index([category])
  @@index([status])
  @@index([isFeatured])
  @@index([state, city])
  @@index([listingType])
  @@map("product_listings")
}

model ProductTransaction {
  id                String              @id @default(cuid())
  productListingId  String
  buyerId           String
  sellerId          String
  
  transactionType   String              // sale, lease, rent
  agreedPrice       Float
  currency          String              @default("NGN")
  
  // External Payment Tracking
  isExternal        Boolean             @default(true)  // All general market payments are external
  externalReference String?             // External payment reference
  externalPlatform  String?             // Where payment occurred
  externalPaymentMethod String?         // Method used
  
  status            String              @default("pending") // pending, completed, cancelled
  completedAt       DateTime?
  
  // Delivery Tracking
  deliveryTracking  String?
  deliveryStatus    String?
  
  // Rating tracking (48-hour window)
  buyerRated        Boolean             @default(false)
  sellerRated       Boolean             @default(false)
  ratingDeadline    DateTime?           // 48 hours from completion
  ratingReminderSent Boolean            @default(false)
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  productListing    ProductListing      @relation(fields: [productListingId], references: [id], onDelete: Cascade)
  ratingInvitations RatingInvitation[]
  
  @@index([productListingId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([ratingDeadline])
  @@map("product_transactions")
}

// ===========================================
// JOB MODELS - ENHANCED
// ===========================================

model Job {
  id                String              @id @default(cuid())
  posterId          String
  
  // Basic Info
  title             String
  slug              String
  description       String              @db.Text
  requirements      String[]
  responsibilities  String[]
  
  // Job Details
  jobType           JobType
  experienceLevel   String?             // entry, mid, senior, executive
  educationLevel    String?
  skills            String[]
  
  // Compensation
  salaryMin         Float?
  salaryMax         Float?
  currency          String              @default("NGN")
  salaryType        String?             // monthly, yearly, hourly, project
  benefits          String[]
  
  // Location
  country           String              @default("Nigeria")
  state             String?
  city             String?
  isRemote          Boolean             @default(false)
  
  // Application
  applicationDeadline DateTime?
  maxApplications   Int?
  applicationCount  Int                 @default(0)
  
  // Status
  status            JobStatus           @default(OPEN)
  isFeatured        Boolean             @default(false)
  featuredUntil     DateTime?
  featuredTxnRef    String?             // Zainpay transaction reference
  
  // Stats
  viewCount         Int                 @default(0)
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  publishedAt       DateTime?
  closedAt          DateTime?
  
  poster            User                @relation("JobPoster", fields: [posterId], references: [id], onDelete: Cascade)
  applications      JobApplication[]
  ratings           Rating[]             // FIXED: Added opposite relation field
  favorites         Favorite[]           // FIXED: Added opposite relation field
  
  @@index([posterId])
  @@index([jobType])
  @@index([status])
  @@index([isFeatured])
  @@index([state, city])
  @@map("jobs")
}

model JobApplication {
  id                String              @id @default(cuid())
  jobId             String
  applicantId       String
  
  coverLetter       String?             @db.Text
  resumeUrl         String?
  portfolioUrl      String?
  
  expectedSalary    Float?
  availableFrom     DateTime?
  
  status            ApplicationStatus   @default(PENDING)
  
  // Employer notes (private)
  employerNotes     String?             @db.Text
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  job               Job                 @relation(fields: [jobId], references: [id], onDelete: Cascade)
  applicant         User                @relation(fields: [applicantId], references: [id], onDelete: Cascade)
  
  @@unique([jobId, applicantId])
  @@index([jobId])
  @@index([applicantId])
  @@index([status])
  @@map("job_applications")
}

// ===========================================
// STAFF & SQUAD MODELS - ENHANCED
// ===========================================

model Staff {
  id                String              @id @default(cuid())
  employerId        String
  employeeId        String
  
  role              StaffRole           @default(EMPLOYEE)
  title             String?
  department        String?
  
  status            StaffStatus         @default(PENDING)
  
  startDate         DateTime?
  endDate           DateTime?
  
  // Permissions
  permissions       String[]
  
  // Rating tracking for termination
  employerRated     Boolean             @default(false)
  employeeRated     Boolean             @default(false)
  ratingDeadline    DateTime?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  employer          User                @relation("Employer", fields: [employerId], references: [id], onDelete: Cascade)
  employee          User                @relation("Employee", fields: [employeeId], references: [id], onDelete: Cascade)
  ratings           Rating[]            // FIXED: Added opposite relation field
  ratingInvitations RatingInvitation[] // FIXED: Added opposite relation field
  
  @@unique([employerId, employeeId])
  @@index([employerId])
  @@index([employeeId])
  @@index([status])
  @@map("staff")
}

model Squad {
  id                String              @id @default(cuid())
  ownerId           String
  
  name              String
  slug              String              @unique
  description       String?             @db.Text
  logo              String?
  coverImage        String?
  
  // Service Type Association (for marketplace permissions)
  serviceTypeId     String?
  
  // Verification
  status            SquadStatus         @default(PENDING_VERIFICATION)
  verifiedAt        DateTime?
  verificationFeePaid Boolean           @default(false)
  verificationTxnRef String?            // Zainpay transaction reference
  
  // Stats
  memberCount       Int                 @default(1)
  averageRating     Float               @default(0)
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  owner             User                @relation("SquadOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  serviceType       ServiceType?        @relation(fields: [serviceTypeId], references: [id])
  members           SquadMember[]
  
  @@index([ownerId])
  @@index([status])
  @@index([serviceTypeId])
  @@map("squads")
}

model SquadMember {
  id                String              @id @default(cuid())
  squadId           String
  userId            String
  
  role              String              @default("member") // owner, admin, member
  joinedAt          DateTime            @default(now())
  
  squad             Squad               @relation(fields: [squadId], references: [id], onDelete: Cascade)
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([squadId, userId])
  @@index([squadId])
  @@index([userId])
  @@map("squad_members")
}

// ===========================================
// MESSAGING MODELS
// ===========================================

model ChatRoom {
  id                String              @id @default(cuid())
  
  name              String?
  description       String?
  image             String?
  
  type              String              @default("direct") // direct, group, community, marketplace
  isPublic          Boolean             @default(false)
  
  // For marketplace chats
  listingType       String?             // vehicle, property, product, service, job
  listingId         String?
  
  // For community rooms
  topic             String?
  maxMembers        Int?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  members           ChatRoomMember[]
  messages          Message[]
  
  @@index([type])
  @@index([listingType, listingId])
  @@map("chat_rooms")
}

model ChatRoomMember {
  id                String              @id @default(cuid())
  chatRoomId        String
  userId            String
  
  role              String              @default("member") // admin, moderator, member
  joinedAt          DateTime            @default(now())
  mutedUntil        DateTime?
  
  // Read tracking
  lastReadAt        DateTime?
  
  chatRoom          ChatRoom            @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([chatRoomId, userId])
  @@index([chatRoomId])
  @@index([userId])
  @@map("chat_room_members")
}

model Message {
  id                String              @id @default(cuid())
  chatRoomId        String
  senderId          String
  
  type              MessageType         @default(TEXT)
  content           String?             @db.Text
  mediaUrl          String?
  mediaThumbnail    String?
  
  // Reply
  replyToId         String?
  
  // For marketplace messages
  isMarketplaceInquiry Boolean          @default(false)
  listingType       String?             // vehicle, property, product, service
  listingId         String?
  
  isEdited          Boolean             @default(false)
  isDeleted         Boolean             @default(false)
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  chatRoom          ChatRoom            @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  sender            User                @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  replyTo           Message?            @relation("MessageReplies", fields: [replyToId], references: [id])
  replies           Message[]           @relation("MessageReplies")
  
  @@index([chatRoomId])
  @@index([senderId])
  @@index([createdAt])
  @@index([isMarketplaceInquiry])
  @@map("messages")
}

// ===========================================
// RATING & REVIEW MODELS - ENHANCED
// ===========================================

model Rating {
  id                String              @id @default(cuid())
  giverId           String
  receiverId        String
  
  category          RatingCategory
  
  // Related Entity
  serviceId         String?
  bookingId         String?
  vehicleListingId  String?
  propertyListingId String?
  productListingId  String?
  jobId             String?
  staffId           String?
  
  // Ratings (1-5)
  overallRating     Int
  
  // Category-specific ratings (from workflow)
  qualityRating     Int?                // For services
  punctualityRating Int?                // For services
  communicationRating Int?              // For services, vehicles, properties, products
  valueRating       Int?                // For services
  
  accuracyRating    Int?                // For vehicles, properties, products
  conditionRating   Int?                // For vehicles, properties, products
  transactionRating Int?                // For vehicles, properties, products
  
  // Review
  review            String?             @db.VarChar(500)
  
  // Moderation
  isVisible         Boolean             @default(true)
  isReported        Boolean             @default(false)
  moderatedAt       DateTime?
  
  // Rating Invitation Tracking
  ratingInvitationId String?            @unique  // FIXED: Added @unique for one-to-one relation
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  giver             User                @relation("RatingGiver", fields: [giverId], references: [id], onDelete: Cascade)
  receiver          User                @relation("RatingReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  service           Service?            @relation(fields: [serviceId], references: [id])
  booking           Booking?            @relation(fields: [bookingId], references: [id])
  vehicleListing    VehicleListing?     @relation(fields: [vehicleListingId], references: [id])
  propertyListing   PropertyListing?    @relation(fields: [propertyListingId], references: [id])
  productListing    ProductListing?     @relation(fields: [productListingId], references: [id])
  job               Job?                @relation(fields: [jobId], references: [id])
  staff             Staff?              @relation(fields: [staffId], references: [id])
  response          ReviewResponse?
  ratingInvitation  RatingInvitation?   @relation(fields: [ratingInvitationId], references: [id])
  
  @@index([giverId])
  @@index([receiverId])
  @@index([category])
  @@index([createdAt])
  @@index([ratingInvitationId])
  @@map("ratings")
}

model ReviewResponse {
  id                String              @id @default(cuid())
  ratingId          String              @unique
  responderId       String
  
  response          String              @db.VarChar(500)
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  rating            Rating              @relation(fields: [ratingId], references: [id], onDelete: Cascade)
  responder         User                @relation(fields: [responderId], references: [id], onDelete: Cascade)
  
  @@map("review_responses")
}

model RatingInvitation {
  id                String              @id @default(cuid())
  userId            String
  transactionId     String?
  transactionType   String              // booking, vehicle, property, product, staff
  
  // Use separate fields instead of a single entityId for multiple relations
  bookingId         String?              @unique
  vehicleTransactionId String?
  propertyTransactionId String?
  productTransactionId String?
  staffId           String?
  
  // 48-hour window enforcement
  expiresAt         DateTime
  sentAt            DateTime?
  remindedAt        DateTime?
  
  status            String              @default("pending") // pending, sent, completed, expired
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  booking           Booking?            @relation(fields: [bookingId], references: [id])
  vehicleTransaction VehicleTransaction? @relation(fields: [vehicleTransactionId], references: [id])
  propertyTransaction PropertyTransaction? @relation(fields: [propertyTransactionId], references: [id])
  productTransaction ProductTransaction? @relation(fields: [productTransactionId], references: [id])
  staff             Staff?              @relation(fields: [staffId], references: [id])
  rating            Rating?
  
  @@index([userId])
  @@index([expiresAt])
  @@index([status])
  @@index([transactionType])
  @@index([bookingId])
  @@index([vehicleTransactionId])
  @@index([propertyTransactionId])
  @@index([productTransactionId])
  @@index([staffId])
  @@map("rating_invitations")
}

// ===========================================
// FAVORITES MODEL
// ===========================================

model Favorite {
  id                String              @id @default(cuid())
  userId            String
  
  // Only one of these will be set
  serviceId         String?
  vehicleListingId  String?
  propertyListingId String?
  productListingId  String?
  jobId             String?
  
  createdAt         DateTime            @default(now())
  
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  service           Service?            @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  vehicleListing    VehicleListing?     @relation(fields: [vehicleListingId], references: [id], onDelete: Cascade)
  propertyListing   PropertyListing?    @relation(fields: [propertyListingId], references: [id], onDelete: Cascade)
  productListing    ProductListing?     @relation(fields: [productListingId], references: [id], onDelete: Cascade)
  job               Job?                @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  @@unique([userId, serviceId])
  @@unique([userId, vehicleListingId])
  @@unique([userId, propertyListingId])
  @@unique([userId, productListingId])
  @@unique([userId, jobId])
  @@index([userId])
  @@map("favorites")
}

// ===========================================
// NOTIFICATION MODEL - ENHANCED
// ===========================================

model Notification {
  id                String              @id @default(cuid())
  userId            String
  
  type              NotificationType
  title             String
  message           String
  
  // Action
  actionUrl         String?
  metadata          Json?
  
  // AI Insights integration
  aiInsightId       String?
  
  isRead            Boolean             @default(false)
  readAt            DateTime?
  
  createdAt         DateTime            @default(now())
  
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  aiInsight         AIInsight?          @relation(fields: [aiInsightId], references: [id])
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([aiInsightId])
  @@map("notifications")
}

// ===========================================
// REPORT MODEL
// ===========================================

model Report {
  id                String              @id @default(cuid())
  reporterId        String
  reportedUserId    String?
  
  // What is being reported
  entityType        String              // user, service, vehicle, property, product, message, review
  entityId          String
  
  reason            ReportReason
  description       String?             @db.Text
  evidence          String[]            // URLs to screenshots, etc.
  
  status            ReportStatus        @default(PENDING)
  resolution        String?
  resolvedBy        String?
  resolvedAt        DateTime?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  reporter          User                @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reportedUser      User?               @relation("Reported", fields: [reportedUserId], references: [id])
  
  @@index([reporterId])
  @@index([reportedUserId])
  @@index([status])
  @@map("reports")
}

// ===========================================
// AI INSIGHTS MODEL - ENHANCED WITH RAG SYSTEM
// ===========================================

model AIInsight {
  id                String              @id @default(cuid())
  userId            String
  
  type              AIInsightType
  category          String?             // service, vehicle, property, product, general
  
  title             String
  content           String              @db.Text
  
  // RAG System Integration
  data              Json?               // Structured insight data
  confidence        Float?              // 0-1 confidence score
  sources           Json?               // Retrieved context sources from Pinecone
  vectorIds         String[]            // Pinecone vector IDs used
  queryId           String?             // Related AI query
  
  // Free Tier Limitations
  tierAccess        SubscriptionTier    @default(FREE)  // Minimum tier required
  
  isRead            Boolean             @default(false)
  readAt            DateTime?
  
  expiresAt         DateTime?
  
  createdAt         DateTime            @default(now())
  
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  aiQuery           AIQuery?            @relation(fields: [queryId], references: [id])
  notifications     Notification[]
  
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([tierAccess])
  @@map("ai_insights")
}

model AIQuery {
  id          String   @id @default(cuid())
  userId      String
  query       String   @db.Text
  response    Json?
  intent      String?
  module      String?  // vehicle, property, service, general
  metadata    Json?
  
  // RAG System Integration
  vectorEmbedding Json?               // Pinecone vector embedding
  contextWindowSize Int?              // 128K, 64K, etc.
  pineconeIndexId String?             // Pinecone index used
  responseSources Json?               // Retrieved context sources
  
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  insights    AIInsight[]
  
  @@index([userId])
  @@index([module])
  @@index([createdAt])
  @@map("ai_queries")
}

// ===========================================
// FINANCIAL SERVICE MODELS - ENHANCED
// ===========================================

model InsurancePackage {
  id                String              @id @default(cuid())
  providerId        String
  
  // Provider Type (linked to ServiceType IDs)
  providerType      String              // general (135), property (137), vehicle (138)
  
  name              String
  description       String              @db.Text
  type              String              // vehicle, property, general
  
  coverageDetails   Json
  premiumRange      Json                // { min: Float, max: Float }
  
  terms             String?             @db.Text
  externalQuoteLink String?
  
  isActive          Boolean             @default(true)
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  @@index([providerId])
  @@index([type])
  @@index([providerType])
  @@map("insurance_packages")
}

model FinancingPackage {
  id                String              @id @default(cuid())
  providerId        String
  
  // Provider Type (linked to ServiceType IDs)
  providerType      String              // vehicle (136), property (139), general (140)
  
  name              String
  description       String              @db.Text
  type              String              // vehicle, property (mortgage), general
  
  interestRateMin   Float?
  interestRateMax   Float?
  tenureMinMonths   Int?
  tenureMaxMonths   Int?
  
  eligibilityRequirements String[]
  requiredDocuments String[]
  
  externalCalculatorLink String?
  externalApplyLink String?
  
  isActive          Boolean             @default(true)
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  @@index([providerId])
  @@index([type])
  @@index([providerType])
  @@map("financing_packages")
}

// ===========================================
// TALENT POOL MODEL - ENHANCED
// ===========================================

model TalentPoolEntry {
  id            String   @id @default(cuid())
  userId        String   @unique
  
  headline      String?
  skills        String[]
  experience    Json?
  expectedSalary Float?
  availability  String?  // immediate, 2_weeks, 1_month
  
  // Visibility Controls
  isActive      Boolean  @default(true)
  isPublic      Boolean  @default(true)  // Can be discovered by employers
  tierAccess    SubscriptionTier @default(FREE)  // Minimum tier to view
  
  lastUpdated   DateTime @updatedAt
  createdAt     DateTime @default(now())
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([isActive])
  @@index([skills])
  @@index([isPublic])
  @@index([tierAccess])
  @@map("talent_pool_entries")
}

// ===========================================
// SUBSCRIPTION USAGE TRACKING
// ===========================================

model SubscriptionUsage {
  id                    String       @id @default(cuid())
  subscriptionId        String
  period                String       // e.g., "2024-01"
  
  serviceListingsUsed   Int          @default(0)
  vehicleListingsUsed   Int          @default(0)
  propertyListingsUsed  Int          @default(0)
  productListingsUsed   Int          @default(0)
  featuredListingsUsed  Int          @default(0)
  
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  
  subscription          Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  @@unique([subscriptionId, period])
  @@index([subscriptionId])
  @@map("subscription_usages")
}

// ===========================================
// SYSTEM MODELS
// ===========================================

model SystemSetting {
  id                String              @id @default(cuid())
  key               String              @unique
  value             Json
  description       String?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  @@map("system_settings")
}

model AuditLog {
  id                String              @id @default(cuid())
  userId            String?
  
  action            String
  entityType        String
  entityId          String?
  
  oldData           Json?
  newData           Json?
  
  ipAddress         String?
  userAgent         String?
  
  createdAt         DateTime            @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// ===========================================
// MARKETPLACE INQUIRY MODELS
// ===========================================

model MarketplaceInquiry {
  id                String              @id @default(cuid())
  listingId         String
  listingType       String              // vehicle, property, product
  inquirerId        String
  ownerId           String
  
  message           String              @db.Text
  status            String              @default("pending") // pending, responded, closed
  
  // Contact visibility
  inquirerContactVisible Boolean        @default(false)  // Based on subscription
  ownerContactVisible    Boolean        @default(true)
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  respondedAt       DateTime?
  
  @@index([listingId, listingType])
  @@index([inquirerId])
  @@index([ownerId])
  @@index([status])
  @@map("marketplace_inquiries")
}

// ===========================================
// SERVICE TYPE PERMISSION MAPPING
// ===========================================

model ServicePermissionMap {
  id                String              @id @default(cuid())
  serviceId         Int                 @unique  // 1-140
  
  // Permissions from workflow document
  canPostVehicles   Boolean             @default(false)
  canPostProperties Boolean             @default(false)
  isFinancialProvider Boolean           @default(false)
  isRealEstateProvider Boolean          @default(false)
  isVehicleProvider Boolean             @default(false)
  
  // Specific service IDs from workflow
  specificRole      String?             // Vehicle Dealer, Real Estate Agent, etc.
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  @@index([serviceId])
  @@map("service_permission_maps")
}